{% extends '_layout.jinja2' %}
{% import 'utils/_progress.jinja2' as progress %}

{% macro present_issues(issues, with_avatar=true, with_box=true, grouper=none) %}
  <ul>
    {% for issue in issues %}
    <li class="{{ issue.state }}{%- if issue.pull_request %} pull-request{%- endif -%}">
        {% if with_box %}
            <input class="issues {{ grouper }}" type="checkbox" name="issues" onclick="toggleparent(this, '{{ grouper }}')" value="{{issue.repository_url | short_name }}${{ issue.number }}$
            {%- for label in issue.labels -%}
              {{ label.name }}
              {%-if not loop.last -%},{%- endif -%}
            {%- endfor -%}"/>
        {% endif %}
        {% if with_avatar %}
          {% for assignee in issue.assignees %}
            <img class="user-avatar" src="{{ assignee.avatar_url or url_for('static', filename='images/question-mark.png')}}" alt="avatar" title="{{ assignee.login or 'not assigned' }}"/>
          {% endfor %}
        {% endif %}
        <a href="{{ issue.html_url }}">
          <span class="issue-title">{{ issue.title | striptags }}</span>
          <span class="issue-id">#{{ issue.number }}</span>
          <span class="project">{{ issue.repository_url | short_name }}</span>
          {% for label in issue.labels %}
            <span class="issues-label label-{{ label.name }}">{{ label.name }}</span>
          {% endfor %}
          {{ progress.render(issue.opened, issue.closed) }}
          {% if with_box %}
        </a>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% endmacro %}

{% macro mk_labeled_input(type, name, value, label) %}
  <input type="{{ type }}" name="{{ name }}" id="{{ name }}_{{ value }}" value="{{ value }}" {{ 'checked' if value in filters[name] }} onChange="submit_forms()" />
  <label for="{{ name }}_{{ value }}" {% if name == 'label' %}class="issues-label label-{{ label }}"{% endif %}>{{ label }}</label>
{% endmacro %}

{% block filter %}
  <nav>
    <form action="{{ url_for('show_form_query') }}" method="get" id="issue_filter_2">
      <fieldset class="github_labels">
        <legend>Priority</legend>
        {% for label, color in config.PRIORITY_LABELS %}
          {{ mk_labeled_input('checkbox', 'label', label, label) }}
        {% endfor %}
      </fieldset>
      <fieldset class="github_labels">
        <legend>Type</legend>
        {% for label, color in config.QUALIFIER_LABELS %}
          {{ mk_labeled_input('checkbox', 'label', label, label) }}
        {% endfor %}
      </fieldset>
      <input type="submit" id="useless-submit" />
    </form>

  </nav>
{% endblock filter %}

{% block status %}
  <form action="{{ url_for('show_form_query') }}" method="get" id="issue_filter_1" onSubmit="submit_forms(); return false">
    <fieldset class="state">
      <legend>State</legend>
      {{ mk_labeled_input('radio', 'state', 'open', 'Open') }}
      {{ mk_labeled_input('radio', 'state', 'closed', 'Closed') }}
      {{ mk_labeled_input('radio', 'state', 'all', 'All') }}
    </fieldset>
    <input type="hidden" name="assignee" value="{{ filters.assignee }}"/>
    <fieldset class="groupby">
      <legend>Group by</legend>
      {% for value in ('', 'assignee.logins', 'milestone.title', 'state', 'repository_url') %}
        <input type="radio" name="groupby" id="groupby_{{ value }}" value="{{ value }}" {{ 'checked' if value == (groupby or '') }} onChange="submit_forms()" /><label for="groupby_{{ value }}">{{ groupers[value] if value else "Don't Group"}}</label>
      {% endfor %}
    </fieldset>
    <fieldset class="query">
      <input type="text" name="simple_query" value="{{ filters.simple_query }}">
    </fieldset>
  </form>
{% endblock status %}

{% block main %}
  {% set with_avatar = true %}
  <form method="post" action="{{ url_for('apply_labels')}} ">
  <h1>
    {% set nb_issues = issues | length + noned_issues | length %}
    {{ nb_issues }}
    {% if nb_issues == 1%}
      Issue
    {% else %}
      Issues
    {% endif %}
    {% if groupby %}Grouped by {{ groupers[groupby] }}{% endif %}
    <input id="gaia" type="checkbox" onclick="toggle(this, 'issues')"/>
    {{ progress.render(opened, closed) }}
  </h1>
    <input type="hidden" name="query" value="{{ query }}"/>
  {% if groupby %}
    {% if groupby == 'assignee.logins' %}
      {% set with_avatar = false %}
    {% endif %}
    {% for issue in issues | groupby(groupby) | sort_by_len(reverse=True) %}
      <article>
        <h2>
          {% if groupby == 'assignee.logins' %}
            {% for assignee in issue.list[0].assignees %}
              <img class="user-avatar" src="{{ assignee.avatar_url }}" alt="avatar" />
            {% endfor %}
          {% elif groupby == 'milestone.title' %}
            {{ issue.list[0].repository_url | short_name }} -
          {% endif %}
          {% if groupby == 'repository_url' %}
            {{ issue.grouper | short_name }}
          {% else %}
            {{ issue.grouper }}
          {% endif %}
          <input type="checkbox" class="issues parent {{ issue.grouper }}" onclick="toggle(this, '{{ issue.grouper }}')"/>
        </h2>
        {{ present_issues(issue.list, with_avatar, grouper=issue.grouper) }}
      </article>
    {% endfor %}
    {% if noned_issues %}
      <article>
        <h2>
          {% if groupby == 'assignee.logins' %}
            <img class="user-avatar" src="{{ url_for('static', filename="images/question-mark.png") }}" alt="avatar" />
            Unassigned
          {% else %}
            None
          {% endif %}
          <input type="checkbox" class="parent None issues" onclick="toggle(this, 'None')"/>
        </h2>
        {{ present_issues(noned_issues, with_avatar, grouper='None') }}
      </article>
    {% endif %}
  {% else %}
    <article>
      <h2>
        Overall
        <input type="checkbox" class="issues" onclick="toggle(this, 'Overall')"/>
      </h2>
      {{ present_issues(issues, with_avatar, grouper='Overall') }}
    </article>
  {% endif %}
  <button name="increment_priority" type="submit" title="increment priority label">Increment priority</button>
  <button name="delete_top_priority" type="submit" title="remove sprint label">Remove top priority</button>
  </form>
{% endblock main %}

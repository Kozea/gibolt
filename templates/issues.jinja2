{% extends '_layout.jinja2' %}
{% import 'utils/_progress.jinja2' as progress %}

{% macro present_issues(issues, with_avatar=true, with_box=true, grouper=none) %}
  <ul>
    {% for issue in issues %}
    <li class="{{ issue.state }}{%- if issue.pull_request %} pull-request{%- endif -%}">
        {% if with_box %}
          <label>
            <input class="issues {{ grouper }}" type="checkbox" name="issues" onclick="toggleparent(this, '{{ grouper }}')" value="{{issue.repository.full_name | short_name }}${{ issue.number }}$
            {%- for label in issue.labels -%}
              {{ label.name }}
              {%-if not loop.last -%},{%- endif -%}
            {%- endfor -%}"/>
        {% endif %}
        {% if with_avatar %}
          <img class="mini-user-avatar" src="{{ issue.assignee.avatar_url or url_for('static', filename='images/question-mark.png')}}" alt="avatar" title="{{ issue.assignee.login or 'not assigned' }}"/>
        {% endif %}
        <span class="project">{{ issue.repository.full_name | short_name }}</span>
        {% for label in issue.labels %}
          <span class="issues-label">{{ label.name }}</span>
        {% endfor %}
        <a href="{{ issue.html_url }}">#{{ issue.number }}</a> {{ issue.title | striptags }}
        {{ progress.render(issue.opened, issue.closed) }}
        {% if with_box %}
          </label>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% endmacro %}

{% macro mk_labeled_input(type, name, value, label) %}
  <input type="{{ type }}" name="{{ name }}" id="{{ name }}_{{ value }}" value="{{ value }}" {{ 'checked' if value in filters[name] }} onChange="this.form.submit()" />
  <label for="{{ name }}_{{ value }}">{{ label }}</label>
{% endmacro %}

{% block sidenav %}
  <nav>
    <form action="{{ url_for('show_form_query') }}" method="get">
      <fieldset class="github_labels">
        <legend>Priority</legend>
        {{ mk_labeled_input('checkbox', 'labels', 'sprint', 'sprint') }}
        {{ mk_labeled_input('checkbox', 'labels', 'next', 'next') }}
        {{ mk_labeled_input('checkbox', 'labels', 'must', 'must') }}
        {{ mk_labeled_input('checkbox', 'labels', 'nice', 'nice') }}
        {{ mk_labeled_input('checkbox', 'labels', 'later', 'later') }}
      </fieldset>
      <fieldset class="github_labels">
        <legend>Type</legend>
        {{ mk_labeled_input('checkbox', 'labels', 'feature', 'feature') }}
        {{ mk_labeled_input('checkbox', 'labels', 'bug', 'bug') }}
        {{ mk_labeled_input('checkbox', 'labels', 'document', 'doc') }}
        {{ mk_labeled_input('checkbox', 'labels', 'commercial', 'commercial') }}
        {{ mk_labeled_input('checkbox', 'labels', 'design', 'design') }}
        {{ mk_labeled_input('checkbox', 'labels', 'tool', 'tool') }}
        {{ mk_labeled_input('checkbox', 'labels', 'debt', 'debt') }}
      </fieldset>
      <input type="submit" id="useless-submit" />
    </form>

  </nav>
{% endblock sidenav %}

{% block topnav %}
  <form action="{{ url_for('show_form_query') }}" method="get">
    <fieldset class="state">
      <legend>State</legend>
      {{ mk_labeled_input('radio', 'state', 'open', 'open') }}
      {{ mk_labeled_input('radio', 'state', 'closed', 'closed') }}
      {{ mk_labeled_input('radio', 'state', 'all', 'all') }}
    </fieldset>
    <fieldset class="groupby">
      <legend>Group by</legend>
      {% for value in ('', 'assignee.login', 'milestone.title', 'state', 'repository.full_name') %}
        <input type="radio" name="groupby" id="groupby_{{ value }}" value="{{ value }}" {{ 'checked' if value == groupby }} onChange="this.form.submit()" /><label for="groupby_{{ value }}">{{ groupers[value] if value else "Don't Group"}}</label>
      {% endfor %}
    </fieldset>
  </form>
{% endblock topnav %}

{% block main %}
  {% set with_avatar = true %}
  <form method="post" action="{{ url_for('apply_labels')}} ">
  <h1>
    {% set nb_issues = issues | length + noned_issues | length %}
    {{ nb_issues }}
    {% if nb_issues == 1%}
      Issue
    {% else %}
      Issues
    {% endif %}
    {% if groupby %}Grouped by {{ groupers[groupby] }}{% endif %}
    <input id="gaia" type="checkbox" onclick="toggle(this, 'issues')"/>
    {{ progress.render(opened, closed) }}
  </h1>
    <input type="hidden" name="query" value="{{ query }}"/>
  {% if groupby %}
    {% if groupby == 'assignee.login' %}
      {% set with_avatar = false %}
    {% endif %}
    {% for issue in issues | groupby(groupby) | sort_by_len(reverse=True) %}
      <article>
        <h2>
          {% if groupby == 'assignee.login' %}
            <img class="user-avatar" src="{{ issue.list[0].assignee.avatar_url }}" alt="avatar" />
          {% elif groupby == 'milestone.title' %}
            {{ issue.list[0].repository.full_name | short_name }} -
          {% endif %}
          {{ issue.grouper }}
          <input type="checkbox" class="issues parent {{ issue.grouper }}" onclick="toggle(this, '{{ issue.grouper }}')"/>
        </h2>
        {{ present_issues(issue.list, with_avatar, grouper=issue.grouper) }}
      </article>
    {% endfor %}
    {% if noned_issues %}
      <article>
        <h2>
          {% if groupby == 'assignee.login' %}
            <img class="user-avatar" src="{{ url_for('static', filename="images/question-mark.png") }}" alt="avatar" />
            Unassigned
          {% else %}
            None
          {% endif %}
          <input type="checkbox" class="parent None issues" onclick="toggle(this, 'None')"/>
        </h2>
        {{ present_issues(noned_issues, with_avatar, grouper='None') }}
      </article>
    {% endif %}
  {% else %}
    <article>
      <h2>
        Overall
        <input type="checkbox" class="issues" onclick="toggle(this, 'Overall')"/>
      </h2>
      {{ present_issues(issues, with_avatar, grouper='Overall') }}
    </article>
  {% endif %}
  <button name="next_to_sprint" type="submit" title="remove next label and apply sprint label">next to sprint</button>
  <button name="delete_sprint" type="submit" title="remove sprint label">remove sprint</button>
  <button name="add_next" type="submit" title="add next label">add next</button>
  </form>
{% endblock main %}

{% extends '_layout.jinja2' %}

{% macro present_issues(issues, with_avatar=true, with_box=true) %}
  <ul>
    {% for issue in issues %}
      <li class="{{ issue.state }}">
        {% if with_box %}
          {% set labels =  [] %}
          {% for label in issue.labels %}
            {% set joinedlabels = joinedlabels + label.name %}
          {% endfor %}
            {{ joinedlabels }}
          <label>
            <input type="checkbox" name="issues" value="{{issue.repository.full_name | short_name }}-{{ issue.number }}-{{ labels }}"/>
        {% endif %}
        {% if with_avatar %}
          <img class="mini-user-avatar" src="{{ issue.assignee.avatar_url or url_for('static', filename='images/question-mark.png')}}" alt="avatar" title="{{ issue.assignee.login or 'not assigned' }}"/>
        {% endif %}
        <span class="project">{{ issue.repository.full_name | short_name }}</span>
        {% for label in issue.labels %}
          <span class="issues-label" style="background: #{{ label.color }}; color: {{ label.color | text_color }}">{{ label.name }}</span>
        {% endfor %}
        <a href="{{ issue.html_url }}">#{{ issue.number }}</a> {{ issue.title | striptags }}
        {{ progress(issue.opened, issue.closed) }}
        {% if with_box %}
          </label>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% endmacro %}

{% macro mk_labeled_input(type, name, value, label) %}
  <input type="{{ type }}" name="{{ name }}" id="{{ name }}_{{ value }}" value="{{ value }}" {{ 'checked' if value in filters[name] }} onChange="this.form.submit()" />
  <label for="{{ name }}_{{ value }}">{{ label }}</label>
{% endmacro %}

{% block sidenav %}
  <nav>
    <form action="{{ url_for('show_form_query') }}" method="get">
      <fieldset>
        <legend>State</legend>
        {{ mk_labeled_input('radio', 'state', 'open', 'open') }}
        {{ mk_labeled_input('radio', 'state', 'closed', 'closed') }}
        {{ mk_labeled_input('radio', 'state', 'all', 'all') }}
      </fieldset>
      <fieldset>
        <legend>Priority</legend>
        {{ mk_labeled_input('checkbox', 'labels', 'sprint', 'sprint') }}
        {{ mk_labeled_input('checkbox', 'labels', 'next', 'next') }}
        {{ mk_labeled_input('checkbox', 'labels', 'must', 'must') }}
        {{ mk_labeled_input('checkbox', 'labels', 'nice', 'nice') }}
        {{ mk_labeled_input('checkbox', 'labels', 'later', 'later') }}
      </fieldset>
      <fieldset>
        <legend>Type</legend>
        {{ mk_labeled_input('checkbox', 'labels', 'feature', 'feature') }}
        {{ mk_labeled_input('checkbox', 'labels', 'bug', 'bug') }}
        {{ mk_labeled_input('checkbox', 'labels', 'document', 'doc') }}
        {{ mk_labeled_input('checkbox', 'labels', 'commercial', 'commercial') }}
        {{ mk_labeled_input('checkbox', 'labels', 'design', 'design') }}
        {{ mk_labeled_input('checkbox', 'labels', 'tool', 'tool') }}
        {{ mk_labeled_input('checkbox', 'labels', 'debt', 'debt') }}
      </fieldset>
      <fieldset>
        <legend>Group by</legend>
        <select name="groupby" onChange="this.form.submit()">
          {% for value in ('', 'assignee.login', 'milestone.title', 'state', 'repository.full_name') %}
            <option value="{{ value }}" {{ 'selected' if value == groupby }}>{{ groupers[value] }}</option>
          {% endfor %}
        </select>
      </fieldset>
      <input type="hidden" name="filter" value="all" />
      <input type="submit" id="useless-submit" />
    </form>

    <form method="get" action={{ url_for('show_issues_query') }}>
      <label>Query</label>
      <input value="{{ query }}" size="50" type="text" class="text" name="query">
    </form>
  </nav>
{% endblock sidenav %}

{% block main %}
  {% set with_avatar = true %}
  <h2>
    {% set nb_issues = issues | length + noned_issues | length %}
    {{ nb_issues }}
    {% if nb_issues == 1%}
      Issue
    {% else %}
      Issues
    {% endif %}
    {% if groupby %}Grouped by {{ groupers[groupby] }}{% endif %}
  </h2>
  {{ progress(opened, closed) }}
  <form method="post" action="{{ url_for('apply_labels')}} ">
    <input type="hidden" name="query" value="{{ query }}"/>
  {% if groupby %}
    {% if groupby == 'assignee.login' %}
      {% set with_avatar = false %}
    {% endif %}
    {% for issue in issues | groupby(groupby) | sort_by_len(reverse=True) %}
      <article>
        <h3>
          {% if groupby == 'assignee.login' %}
            <img class="user-avatar" src="{{ issue.list[0].assignee.avatar_url }}" alt="avatar" />
          {% endif %}
          {{ issue.grouper }}
        </h3>
        {{ present_issues(issue.list, with_avatar) }}
      </article>
    {% endfor %}
    {% if noned_issues %}
      <article>
        <h3>
          {% if groupby == 'assignee.login' %}
            <img class="user-avatar" src="{{ url_for('static', filename="images/question-mark.png") }}" alt="avatar" />
            Unassigned
          {% else %}
            None
          {% endif %}
        </h3>
        {{ present_issues(noned_issues, with_avatar) }}
      </article>
    {% endif %}
  {% else %}
    <article>
      <h3>Overall</h3>
      {{ present_issues(issues, with_avatar) }}
    </article>
  {% endif %}
  <button type="submit" title="remove next label and apply sprint label">next to sprint</button>
  </form>
{% endblock main %}
